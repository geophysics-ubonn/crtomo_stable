#!/bin/sh

tools="Griev";

echo "checking for tools"
forcecheck(){
	Ret_val=`which $1`
	if [ -z "$Ret_val" ];then
		echo "$1 not in search path.. searching $HOME..."
		Ret_val=`find $HOME -name "$1" -print`
		if [ -z "$arg" ];then
			exit
		fi
	fi
	return
}

i=1;
for x in $tools;do
	forcecheck $x
	case "$i" in
		1)
			griev=$Ret_val
		;;
		*)
			echo "not possible"
			exit
		;;
	esac
	i=$[$i+1];
done
if [ -e crtomo.cfg ];then
    echo found crtomo.cfg
    elem=`awk '{if (NR==2){print}}' crtomo.cfg`
    elec=`awk '{if (NR==3){print}}' crtomo.cfg`
else
    if [ -e elem.dat ];then
	elem='elem.dat'; 
    else
	echo there is no crtomo.cfg nor elem.dat.. exiting
	exit
    fi
    if [ -e elec.dat ];then
	elec='elec.dat'; 
    else
	echo there is no crtomo.cfg nor elec.dat.. exiting
	exit
    fi
fi


if [ -n $1 ];then 
    mod=$1;
else 
    mod='';
fi

if [ -z $mod ];then
    if [ -e inv.lastmod ];then
	echo found inv.lastmod
	mag=`cat inv.lastmod`
	mod=$mag
	ismag=`echo $mag|grep mag`
#	if [ -n $ismag ];then 
#	    mod=${mag%mag}modl;
#	    awk '{if(NR==1){print}else{print $3,0}}' $mag > $mod
#	fi
    else
	exit
    fi
fi

if [ -e "tmp.fenster" ];then
    titel=`cat tmp.fenster`
else
    titel=$2
fi

if [ -z $titel ];then titel='CRTomo result';fi

if [ -e "tmp.cbarn" ];then
    cbarn=`cat tmp.cbarn`
else
    cbarn=$3
fi
echo $cbarn
if [ -z "$cbarn" ];then cbarn='Units';fi

if [ -e "tmp.crange" ];then
    maxrho=`awk '{print $2}' tmp.crange`
    minrho=`awk '{print $1}' tmp.crange`
fi

# default plot labels
#cls_default_plot_labels:{
#	plot_x_label = "xLabel from Config";
#	plot_y_label = "ylabel from Config";
#	plot_color_label = "CB F C";
#	plot_title = "Unglaublicher Titel aus Config File";
#};

echo 'cls_default_plot_labels:{' > griev.conf
echo '  plot_x_label = "X /m";' >> griev.conf
echo '  plot_y_label = "Y /m";' >> griev.conf
echo '  plot_color_label = "'$cbarn'";' >> griev.conf
echo '  plot_title = "'$titel'";' >> griev.conf
echo '};' >> griev.conf
echo 'aspect_ratio = true;' >> griev.conf


griev_std="-i -e $elem -t $elec"

if [ -e "tmp.crange" ];then
    griev_std="$griev_std -c $minrho -d $maxrho"
fi 
mypdf=`basename $mod|tr '.' '_'`'.pdf'

if [ -n $ismag ];then
    echo $griev_std -y 1 -m $mod -p -o $mypdf
    $griev $griev_std -y 1 -m $mod -p -o $mypdf
else
    echo $griev_std
    $griev $griev_std -r $mod -j -p -o $mypdf
fi